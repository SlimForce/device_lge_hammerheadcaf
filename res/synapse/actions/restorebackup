BB=/sbin/busybox;

SYNAPSE_SD_DIR=/sdcard/Synapse;
SYNAPSE_PROFILE_DIR=$SYNAPSE_SD_DIR/saved_profiles;
SYNAPSE_CONFIG_DIR=$SYNAPSE_SD_DIR/saved_configs;

[ ! -d "$SYNAPSE_PROFILE_DIR" ] && $BB mkdir -p "$SYNAPSE_PROFILE_DIR";
[ ! -d "$SYNAPSE_CONFIG_DIR" ] && $BB mkdir -p "$SYNAPSE_CONFIG_DIR";

if [ -d /data/data/com.af.synapse ]; then
  SYNAPSE_DATA=/data/data/com.af.synapse/databases;
  [ ! -f "$SYNAPSE_PROFILE_DIR/.selected_config_profile" -o -z `$BB cat "$SYNAPSE_PROFILE_DIR/.selected_config_profile" 2> /dev/null` ] && $BB echo "None" > "$SYNAPSE_PROFILE_DIR/.selected_config_profile";
  [ ! -f "$SYNAPSE_CONFIG_DIR/.selected_config_profile" -o -z `$BB cat "$SYNAPSE_CONFIG_DIR/.selected_config_profile" 2> /dev/null` ] && $BB echo "None" > "$SYNAPSE_CONFIG_DIR/.selected_config_profile";
  SYNAPSE_PROFILE=`$BB cat "$SYNAPSE_PROFILE_DIR/.selected_config_profile"`;
  SYNAPSE_CONFIG=`$BB cat "$SYNAPSE_CONFIG_DIR/.selected_config_profile"`;
else
  SYNAPSE_PROFILE="None"
  SYNAPSE_CONFIG="None"
fi;

reset_uci() {
  /res/synapse/uci reset;
  /res/synapse/uci;
}

case "$1" in

	listprofile)
		$BB echo `$BB ls "$SYNAPSE_PROFILE_DIR"`;
	;;

	pickprofile)
		if [ -f "$SYNAPSE_PROFILE_DIR/$2" -o "$2" == "None" ]; then
			$BB echo "$2" > "$SYNAPSE_PROFILE_DIR/.selected_config_profile";
		fi;
		$BB echo `$BB cat "$SYNAPSE_PROFILE_DIR/.selected_config_profile"`;
	;;

	applyprofile)
		CNT=0;
		for FILE in `$BB tar -t -f "$SYNAPSE_PROFILE_DIR/$SYNAPSE_PROFILE" 2> /dev/null`; do
			if [ "$FILE" = "actionValueStore" -o "$FILE" = "actionValueStore-journal" ]; then
				CNT=$((CNT + 1));
			else
				CNT=$((CNT + 99));
			fi;
		done;
		
		if [ $CNT -eq "2" ]; then
			OWNER=`$BB stat -c %u $SYNAPSE_DATA`;
			PERM=`$BB stat -c %a $SYNAPSE_DATA`;
			if [ -f "$SYNAPSE_PROFILE_DIR/$SYNAPSE_PROFILE" ]; then
				$BB rm -f $SYNAPSE_DATA/*;
				cd $SYNAPSE_DATA;
				$BB tar -x -f "$SYNAPSE_PROFILE_DIR/$SYNAPSE_PROFILE";
				$BB chown $OWNER:$OWNER *;
				$BB chmod $PERM *;
				$BB echo "None" > $SYNAPSE_PROFILE_DIR/.selected_config_profile;
				$BB echo "$SYNAPSE_PROFILE restored. Press the Restart Synapse button below to see updated list.";
			elif [ "$SYNAPSE_PROFILE" == "None" ]; then
				$BB echo "None selected.";
			else
				$BB echo "File not found.";
			fi;
		else
			$BB echo "Unable to restore profile. Invalid file."
		fi;
	;;

	keepprofile)
		BCK_PROF=`$BB cat /res/synapse/files/bck_prof`;
		BCK_PROF=`$BB echo ${BCK_PROF// /_}`;
	
		if [ "$BCK_PROF" == "None" ]; then
			$BB echo "Enter a profile name first and then apply.";
		else
			cd $SYNAPSE_DATA;
			$BB echo "None" > /res/synapse/files/bck_prof;
			$BB tar -c -f "$SYNAPSE_PROFILE_DIR/$BCK_PROF.tgz" *;
			$BB echo "$BCK_PROF.tgz created. Press the Restart Synapse button below to see updated list.";
		fi;
	;;

	delprofile)
		if [ -f "$SYNAPSE_PROFILE_DIR/$SYNAPSE_PROFILE" ]; then
			$BB rm -f "$SYNAPSE_PROFILE_DIR/$SYNAPSE_PROFILE";
			$BB echo "None" > $SYNAPSE_PROFILE_DIR/.selected_config_profile;
			$BB echo "$SYNAPSE_PROFILE removed. Press the Restart Synapse button below to see updated list.";
		elif [ "$SYNAPSE_PROFILE" == "None" ]; then
			$BB echo "None selected.";
		else
			$BB echo "File not found.";
		fi;
	;;
	
	listconfig)
		$BB echo `$BB ls "$SYNAPSE_CONFIG_DIR"`;
	;;
	
	pickconfig)
		if [ -f "$SYNAPSE_CONFIG_DIR/$2" -o "$2" == "None" ]; then
			$BB echo "$2" > "$SYNAPSE_CONFIG_DIR/.selected_config_profile";
		fi;
		$BB echo `$BB cat "$SYNAPSE_CONFIG_DIR/.selected_config_profile"`;
	;;
	
	delconfig)
		if [ -f "$SYNAPSE_CONFIG_DIR/$SYNAPSE_CONFIG" ]; then
			$BB rm -f "$SYNAPSE_CONFIG_DIR/$SYNAPSE_CONFIG";
			$BB echo "None" > $SYNAPSE_CONFIG_DIR/.selected_config_profile;
			$BB echo "$SYNAPSE_CONFIG removed. Press the Restart Synapse button below to see updated list.";
		elif [ "$SYNAPSE_CONFIG" == "None" ]; then
			$BB echo "None selected.";
		else
			$BB echo "File not found.";
		fi;
	;;
	
	restart)
		am force-stop com.af.synapse 2> /dev/null;
		reset_uci;
		$BB sleep 4;
		am start -a android.intent.action.MAIN -n com.af.synapse/.MainActivity 2> /dev/null;
	;;
esac;
